## <b>性能优化概述</b> ##

### 一. 优化的依据 ###
- 客户的反馈
- 日志记录
- 服务器性能监控 CPU， 内存， 磁盘
- 数据库内部逻辑设计

### 二. 优化的方向 ###
- <b>选择适合的 DBMS</b>
    1. 对事务性处理以及安全性要求高的话，可以选择商业的数据库产品。比如：SQL Server，单表存储上亿条数据是没有问题的。
    2. NoSQL 阵营包括键值型数据库、文档型数据库、搜索引擎、列式存储和图形数据库。这些数据库的优缺点和使用场景各有不同。
    3. 列式存储数据库可以大幅度降低系统的 I/O，适合于分布式文件系统和 OLAP；不适用于数据频繁地增删改。

- <b>表的优化</b>
    1. 表结构要尽量遵循第三范式，减少冗余字段。
    2. 如果分析查询应用比较多，尤其是需要进行多表联查的时候，可以采用反范式进行优化（用空间换时间，通过增加冗余字段）。
    3. 表字段的数据类型选择，关系到了查询效率的高低以及存储空间的大小（数值类型>字符类型）。

- <b>优化逻辑查询</b>
    1. 逻辑查询优化
        - 重写查询: 数学基础就是关系代数
            ```SQL
                -- 子查询优化
                -- EXIST / IN 小表驱动大表原则
                -- WHERE子句避免使用函数；函数会使索引失效

                -- 等价谓词重写
                -- 视图重写
                -- 条件简化
                -- 连接消除
                -- 嵌套连接消除
            ```
        - 换种效率更高的写法

    2. 物理查询优化 【在确定了逻辑查询优化之后】
        - 将逻辑查询的内容变成可以被执行的物理操作符，为后续执行器的执行提供准备
            ```SQL
                -- 核心是高效地建立索引【物理优化技术】，并通过这些索引来做各种优化
                -- 什么时候需要创建索引？
                -- 重复度超过 10% 的情况下，可以不创建这个字段的索引
                -- 创建联合索引的时会对多个字段创建索引，这时索引的顺序很重要
                -- 索引多也就意味着需要更多的存储空间
            ```

        - 根据数据表的计算代价模型【索引情况和数据情况】确定访问执行路径
            ```SQL
                -- 物理查询优化阶段需要确定这些查询所采用的路径
                -- 1. 单表查询：可以全表扫描所有的数据，也可以局部扫描
                -- 2. 多表查询：嵌套循环连接、HASH 连接和合并连接；连接顺序也很重要
            ```

    3. 逻辑查询优化是在SQL语句和逻辑层面进行优化，物理查询优化是具体的查询实现方式的优化
        - 比如：我们目标数据集合比较大，可以通过查询非目标数据集合，然后进行逻辑取反【逻辑查询优化】
        - 比如：select 时可以选择 索引查询或普通查询；join(内连接/笛卡尔/外连接) 时可以指定底下的实现是 嵌套/hash/合并连接。

- <b>选择合适的数据库引擎</b>
    1. Redis 和 Memcached 都可以将数据存放到内存中。Redis 支持持久化，可以让数据保存在硬盘上。
    2. Redis 支持 key-value，List，Set，Hash 等数据结构。
    3. Memcached 只支持 key-value

- <b>库级优化</b>
    1. 主从架构优化： 读写分离的【降低主数据库负载】 用主数据库（master）完成写操作，用从数据库（slave）完成读操作。
    2. 数据库分库分表：【数据量级达到亿级以上】
        ```SQL
            -- a. 采用垂直分表的形式，就是将一张数据表分拆成多张结构相同表
            -- b. 采用水平分表的方式，就是将单张数据量大的表按照某个属性维度分成不同的小表
            -- c. 据库中的数据表过多，可以采用垂直分库的方式，将关联的数据表部署在一个数据库上
            -- d. 分拆在提升数据库性能的同时，也会增加维护和使用成本
        ```

        



