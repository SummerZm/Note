## **OpenMcu网络问题**

### **问题背景环境以及解决**
- 1. 视频会议服务器在局域网网通过端口映射使用外网的IP地址。
- 2. 进行视频会议时，客户端设备需要注册到视频会议服务器上，才能进行音视频传输。
- 3. 客户端设备有些是在外网，有些在局域网，有些在另一个局域网。
- 4. 现象
    ```sh
    # 设备能注册到视频会议服务器上
    # 问题一：在另一个局域网的设备客户端的账户IP由192.168.3.12变成服务器所在局域的路由器IP192.168.1.1
    # 问题二：在上视频会议服务器创建会议，并邀请另一个局域网客户端设备参与视频会议；因没法创建音视频流导致，客户端被服务器检测机制关闭
        答：
        a. 现场环境使用了静态端口映射，需要在路由器上对视频会议服务器音视频流端口范围进行映射。
        b. 同时必须在视频会议服务器1420网页 -- 设置 -- SIP -- SIP终端 在NAT路由IP填写视频会议服务器经路由器映射的外网IP地址。
    # 问题三：另一个局域网设备客户端没法发起创建视频会议
        a. 对另一个局域网设备客户端进行抓包发现，客户端用服务器返回的IP【服务器自身所在局域网的IP】发起会议，导致失败。
        b. 正确的场景应该是：服务器返回所在局域网的IP映射后的外网IP。
        c. 奇怪的是问题二中我们已经设置这natip, 照代码逻辑，接口应该返回natip，而不是自身所在局域网的IP。【通过抓包，查看SDP可知】
        d. 经排查发现，虽然修改了配置文件。但natip状态只在服务启动时初始化。改了这个配置必须重启，并不会像其他设置一样实时生效。【排查问题/设计思路】
    # 问题四：另一个局域网设备客户端申请发言的MQTT消息没有收到
        a. 视频会议服务器可以级联，为了避免不同服务器上不同会议的MQTT消息串扰，所以客户端做了过滤。
        b. 由于问题三中返回的是【服务器自身所在局域网的IP】，而客户端注册IP是 【服务器所在局域网的IP映射后的外网IP】，两者不一致，导致发送过来的MQTT消息被滤掉

    # 问题五：端口配置不对，导致无法建立音视频流
        a. 确定音视频流端口有两种方式：SDP协商和原路返回(Port模式)。
        b. 服务器和客户端在互联网上不同局域网时，要使用Port模式，即原路返回。

	# 问题六：下级服务器通过curl库发起http请求向上级服务器获取信息失败
		a. 原因： 整个网络延时50ms左右毫秒，而http的请求也被设置为50ms，导致请求总是超时
    ```

### **SDP中协议中IP地址细节**
- 服务器在局域网络，客户端在另一个局域网内
- 建立音视频流SDP协商时,正确的IP应该是彼此双方的IP外网地址而不是各自的局域网地址
- 待验证
	1. SDP应用层协议数据包中的IP，决定注册到服务器上的账号IP
	2. 路由器是否设置路Nat决定了内网的请求是否能走到外网服务器上
	

### **Centos 网络问题**
- 问题： Centos 服务器能ping通同一局域网内的其他主机，能ssh远程登陆其他主机，但其他主机 ping不通 Centos 服务器，提示被禁止
    ```sh
    #  经过对比发现，出问题的设备服务器 iptable 配置了路由转发，导致到达centos服务器的包都被本机的iptable拒收了
    ```

### **网络延时问题**
- 两个请求由于网络延时,返回先后不一致导致的状态问题
	1. 正常网络返回:
	```sh
	开始状态: 缩屏

	客户端:                 服务端
	==================================
	zoomin请求    --->    更换视频源
    调用全屏显示  <---    状态返回
	=================================
	zoomout请求   --->    更换视频源
    调用缩屏显示  <---    状态返回

	客户端:                 服务端
	==================================
	zoomin请求    --->    更换视频源
	zoomout请求   --->    更换视频源
    调用全屏显示  <---    状态返回
    调用缩屏显示  <---    状态返回

	结束状态: 缩屏
	```

	2. 不稳定网络返回:
	```sh
	开始状态: 缩屏

	客户端:                 服务端
	==================================
	zoomin请求    --->    更换视频源
	zoomout请求   --->    更换视频源
    调用缩屏显示  <---    状态返回     [异常：后发的情求先到]
    调用全屏显示  <---    状态返回

	结束状态: 全屏
	设计上的问题: 情求1和请求2 有状态上的依赖关系
	```

### **多网卡问题**
> **感觉就像是一个跑了应用服务的路由器**
- 每个网络卡连接一个局域网
	1. [应用层]使用 ANY socket 监听所有网卡
	2. [网络层]配置好路由，实现网卡之间的互通






